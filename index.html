<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>SkyRunner - Gelişmiş Uçak Oyunu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at 50% 0%, #ffffff 0, #87cefa 40%, #1b4f72 100%);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .hud {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .panel {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 10px;
            width: min(700px, 95vw);
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(8px);
            color: #fff;
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 14px;
        }

        .panel-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .panel-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            opacity: 0.7;
        }

        .panel-value {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }

        .bar {
            position: relative;
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.15);
            overflow: hidden;
        }

        .bar-fill {
            position: absolute;
            inset: 0;
            width: 50%;
            border-radius: inherit;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
            transition: width 0.15s;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.9;
            text-align: center;
        }

        .badge.badge-stall {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .badge.badge-overspeed {
            border-color: #f1c40f;
            color: #f1c40f;
        }

        .top-left {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.45);
            color: #fff;
            font-size: 12px;
            backdrop-filter: blur(6px);
            max-width: 260px;
        }

        .top-left h1 {
            font-size: 15px;
            margin-bottom: 4px;
        }

        .top-left p {
            font-size: 11px;
            opacity: 0.85;
            line-height: 1.4;
        }

        .message-center {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.45);
            color: #fff;
            font-size: 13px;
            text-align: center;
            min-width: 240px;
            backdrop-filter: blur(5px);
        }

        .message-big {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .controls-hint {
            margin-top: 4px;
            font-size: 11px;
            opacity: 0.85;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.8s ease forwards;
        }

        .fade-out {
            animation: fadeOut 0.4s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }

        .pause-overlay,
        .main-menu {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.08) 0, rgba(0,0,0,0.9) 55%);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 16px;
            z-index: 20;
        }

        .pause-overlay h2,
        .main-menu h1 {
            font-size: 28px;
            letter-spacing: 0.06em;
        }

        .pause-overlay p,
        .main-menu p {
            font-size: 13px;
            opacity: 0.85;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .menu-buttons button {
            border: none;
            padding: 10px 20px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: #fff;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.4);
            transition: transform 0.1s, box-shadow 0.1s, transform 0.1s;
        }

        .menu-buttons button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.5);
        }

        .menu-small {
            font-size: 11px;
            opacity: 0.7;
        }

        .stat-line {
            font-size: 13px;
        }

        .stat-label {
            opacity: 0.7;
        }

        .stat-value {
            font-weight: 600;
        }

        .skin-preview {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }

        .skin-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
            opacity: 0.7;
        }

        .skin-dot.active {
            opacity: 1;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
        }

        @media (max-width: 600px) {
            .panel {
                font-size: 12px;
                gap: 10px;
            }

            .panel-label {
                font-size: 10px;
            }

            .panel-value {
                font-size: 12px;
            }

            .top-left {
                max-width: 230px;
            }

            .pause-overlay h2,
            .main-menu h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <canvas id="gameCanvas"></canvas>

    <!-- SESLER -->
    <audio id="engineSound" src="engine.mp3" loop preload="auto"></audio>
    <audio id="starSound" src="star.mp3" preload="auto"></audio>
    <audio id="gameOverSound" src="gameover.mp3" preload="auto"></audio>
    <audio id="windSound" src="wind.mp3" loop preload="auto"></audio>
    <audio id="stallSound" src="stall.mp3" preload="auto"></audio>
    <audio id="thunderSound" src="thunder.mp3" preload="auto"></audio>

    <div class="hud">
        <div class="top-left">
            <h1>SkyRunner v1.0</h1>
            <p>
                W / ↑ : Gaz · S / ↓ : Yavaşla<br />
                A / ← ve D / → : Yön değiştir<br />
                P: Duraklat · R: Reset · C: Uçak değiştir<br />
                Yıldız topla, fırtınadan kaç, kuşlara dikkat!
            </p>
        </div>

        <div id="centerMessage" class="message-center fade-in">
            <div class="message-big">Uçuşa Hazır ✈️</div>
            <div>Gaz vermek için <strong>W</strong> veya <strong>↑</strong> tuşuna bas.</div>
            <div class="controls-hint">
                Pistten havalan, şehir üstünde dolaş, yıldızları topla. Fırtına bulutlarından uzak dur!
            </div>
        </div>

        <div class="panel">
            <div class="panel-item">
                <div class="panel-label">Hız (kn)</div>
                <div class="panel-value"><span id="speedText">0</span></div>
            </div>
            <div class="panel-item">
                <div class="panel-label">Yükseklik (m)</div>
                <div class="panel-value"><span id="altText">0</span></div>
            </div>
            <div class="panel-item">
                <div class="panel-label">Yakıt</div>
                <div class="bar">
                    <div id="fuelBar" class="bar-fill"></div>
                </div>
            </div>
            <div class="panel-item">
                <div class="panel-label">Skor</div>
                <div class="panel-value"><span id="scoreText">0</span></div>
            </div>
            <div class="panel-item">
                <div class="panel-label">Süre (sn)</div>
                <div class="panel-value"><span id="timeText">0.0</span></div>
            </div>
            <div class="panel-item" style="flex: 0 0 auto;">
                <div class="badge" id="statusBadge">IDLE</div>
            </div>
        </div>
    </div>

    <!-- ANA MENÜ -->
    <div class="main-menu" id="mainMenu">
        <h1>SkyRunner</h1>
        <p>Basit ama hoş grafikli bir 2D uçuş oyunu. Yıldız topla, fırtınalardan kaç, gökyüzünü fethet.</p>

        <div class="menu-buttons">
            <button id="startBtn">Uçuşa Başla</button>
            <button id="muteBtn">Sesi Kapat</button>
            <button id="difficultyBtn">Zorluk: Normal</button>
        </div>

        <div>
            <p class="menu-small">C tuşu ile uçak görünümünü değiştir.</p>
            <div class="skin-preview">
                <div class="skin-dot" data-skin="0" style="background:#ecf0f1;"></div>
                <div class="skin-dot" data-skin="1" style="background:#3498db;"></div>
                <div class="skin-dot" data-skin="2" style="background:#e74c3c;"></div>
            </div>
        </div>
    </div>

    <!-- PAUSE / GAME OVER OVERLAY -->
    <div class="pause-overlay hidden" id="pauseOverlay">
        <h2 id="pauseTitle">Duraklatıldı</h2>
        <p id="pauseSubtitle">Devam etmek için P tuşuna bas veya aşağıdaki butona tıkla.</p>
        <div id="pauseStats">
            <div class="stat-line">
                <span class="stat-label">Uçuş Süresi: </span>
                <span class="stat-value" id="statTime">0 sn</span>
            </div>
            <div class="stat-line">
                <span class="stat-label">Toplanan Yıldız: </span>
                <span class="stat-value" id="statStars">0</span>
            </div>
            <div class="stat-line">
                <span class="stat-label">Maksimum Hız: </span>
                <span class="stat-value" id="statMaxSpeed">0 kn</span>
            </div>
            <div class="stat-line">
                <span class="stat-label">Toplam Skor: </span>
                <span class="stat-value" id="statScore">0</span>
            </div>
        </div>
        <div class="menu-buttons">
            <button id="resumeBtn">Devam Et</button>
            <button id="restartBtn" style="background: linear-gradient(135deg,#e74c3c,#f39c12);">
                Yeniden Başla
            </button>
        </div>
    </div>
</div>

<script>
(function () {
    "use strict";

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    const speedText   = document.getElementById("speedText");
    const altText     = document.getElementById("altText");
    const fuelBar     = document.getElementById("fuelBar");
    const scoreText   = document.getElementById("scoreText");
    const timeText    = document.getElementById("timeText");
    const centerMsg   = document.getElementById("centerMessage");
    const statusBadge = document.getElementById("statusBadge");

    const pauseOverlay  = document.getElementById("pauseOverlay");
    const pauseTitle    = document.getElementById("pauseTitle");
    const pauseSubtitle = document.getElementById("pauseSubtitle");
    const statTime      = document.getElementById("statTime");
    const statStars     = document.getElementById("statStars");
    const statMaxSpeed  = document.getElementById("statMaxSpeed");
    const statScore     = document.getElementById("statScore");
    const resumeBtn     = document.getElementById("resumeBtn");
    const restartBtn    = document.getElementById("restartBtn");

    const mainMenu      = document.getElementById("mainMenu");
    const startBtn      = document.getElementById("startBtn");
    const muteBtn       = document.getElementById("muteBtn");
    const difficultyBtn = document.getElementById("difficultyBtn");
    const skinDots      = document.querySelectorAll(".skin-dot");

    const engineSound   = document.getElementById("engineSound");
    const starSound     = document.getElementById("starSound");
    const gameOverSound = document.getElementById("gameOverSound");
    const windSound     = document.getElementById("windSound");
    const stallSound    = document.getElementById("stallSound");
    const thunderSound  = document.getElementById("thunderSound");

    const keys = {};
    let muted = false;
    let difficulty = "normal"; // "easy", "normal", "hard"

    const plane = {
        x: 0,
        y: 0,
        heading: 0,
        speed: 0,
        maxSpeed: 420,
        accel: 40,
        friction: 18,
        turnSpeed: 2.4,
        vx: 0,
        vy: 0,
        altitude: 80,
        verticalSpeed: 0
    };

    const world = {
        clouds: [],
        stars: [],
        storms: [],
        birds: [],
        lastSpawnCloud: 0,
        lastSpawnStar: 0,
        lastSpawnStorm: 0,
        lastSpawnBirds: 0,
        starCollectRadius: 26,
        time: 0,
        score: 0,
        fuel: 100,
        movedDistance: 0,
        difficultyTimer: 0,
        starSpawnInterval: 2.5,
        finishTime: 180,
        elapsed: 0
    };

    let running = false;
    let gameOver = false;
    let lastTime = performance.now();
    let flightStartTime = performance.now();
    let collectedStars = 0;
    let maxSpeedReached = 0;
    let hasStartedMoving = false;
    let stallActive = false;

    let audioUnlocked = false;
    let engineStarted = false;

    let shakeX = 0;
    let shakeY = 0;
    let shakeIntensity = 0;

    const skins = ["white", "blue", "red"];
    let currentSkin = 0;

    function randRange(min, max) {
        return Math.random() * (max - min) + min;
    }

    function spawnCloud() {
        const w = 160 + Math.random() * 200;
        const h = 60 + Math.random() * 60;
        const y = Math.random() * canvas.height * 0.5;
        const speed = 20 + Math.random() * 40;
        const alpha = 0.3 + Math.random() * 0.4;
        world.clouds.push({ x: canvas.width + w, y, w, h, speed, alpha });
    }

    function spawnStar() {
        const radius = 10 + Math.random() * 6;
        const y = canvas.height * 0.25 + Math.random() * (canvas.height * 0.4);
        const speed = 120;
        world.stars.push({ x: canvas.width + radius * 2, y, r: radius, speed, collected: false });
    }

    function spawnStorm() {
        const r = randRange(80, 140);
        const y = randRange(100, canvas.height * 0.5);
        world.storms.push({
            x: canvas.width + r * 2,
            y,
            r,
            drain: 5,
            lived: 0
        });
    }

    function spawnBirdFlock() {
        const y = randRange(canvas.height * 0.2, canvas.height * 0.65);
        const count = Math.floor(randRange(3, 7));
        const speed = 150;
        world.birds.push({
            x: canvas.width + 80,
            y,
            count,
            speed,
            escaped: false
        });
    }

    function initWorld() {
        world.clouds.length = 0;
        world.stars.length = 0;
        world.storms.length = 0;
        world.birds.length = 0;
        for (let i = 0; i < 8; i++) spawnCloud();
    }

    function playSound(node, volume = 1.0, loop = false) {
        if (!audioUnlocked || !node || muted) return;
        try {
            node.loop = loop;
            node.volume = volume;
            node.currentTime = 0;
            node.play().catch(() => {});
        } catch (e) {}
    }

    function updateEngineSound(dt) {
        if (!audioUnlocked || !engineSound) return;
        const targetVolume = gameOver || !running || muted
            ? 0
            : Math.min(1, 0.2 + (plane.speed / plane.maxSpeed) * 0.8);

        if (!engineStarted && !gameOver) {
            try {
                engineSound.volume = 0;
                engineSound.currentTime = 0;
                engineSound.play().catch(() => {});
                engineStarted = true;
            } catch (e) {}
        }

        if (engineStarted) {
            const currentVol = engineSound.volume;
            const lerp = 5 * dt;
            engineSound.volume = currentVol + (targetVolume - currentVol) * lerp;
            engineSound.playbackRate = 0.85 + (plane.speed / plane.maxSpeed) * 0.5;
        }
    }

    function updateWindSound(dt) {
        if (!audioUnlocked || !windSound) return;
        const base = plane.speed / plane.maxSpeed;
        const targetVolume = gameOver || !running || muted ? 0 : Math.min(0.6, base * 0.6);
        try {
            if (windSound.paused && !gameOver && running && !muted) {
                windSound.volume = 0;
                windSound.currentTime = 0;
                windSound.play().catch(() => {});
            }
            const lerp = 4 * dt;
            windSound.volume = windSound.volume + (targetVolume - windSound.volume) * lerp;
            windSound.playbackRate = 0.8 + base * 0.4;
        } catch (e) {}
    }

    function playStarSound() {
        if (!audioUnlocked || !starSound || muted) return;
        try {
            starSound.currentTime = 0;
            starSound.volume = 0.8;
            starSound.play().catch(() => {});
        } catch (e) {}
    }

    function playGameOverSound() {
        if (!audioUnlocked || !gameOverSound || muted) return;
        try {
            gameOverSound.currentTime = 0;
            gameOverSound.volume = 1;
            gameOverSound.play().catch(() => {});
        } catch (e) {}
    }

    function playStallSound() {
        if (!audioUnlocked || !stallSound || muted) return;
        try {
            stallSound.currentTime = 0;
            stallSound.volume = 0.9;
            stallSound.play().catch(() => {});
        } catch (e) {}
    }

    function playThunderSound() {
        if (!audioUnlocked || !thunderSound || muted) return;
        try {
            thunderSound.currentTime = 0;
            thunderSound.volume = 0.8;
            thunderSound.play().catch(() => {});
        } catch (e) {}
    }

    function shakeCamera(intensity) {
        shakeIntensity = Math.max(shakeIntensity, intensity);
    }

    function updateCameraShake(dt) {
        shakeIntensity *= 0.9;
        if (shakeIntensity < 0.1) {
            shakeX = 0;
            shakeY = 0;
            return;
        }
        shakeX = (Math.random() - 0.5) * shakeIntensity * 10;
        shakeY = (Math.random() - 0.5) * shakeIntensity * 8;
    }

    function update(dt) {
        updateCameraShake(dt);

        if (!running) {
            updateEngineSound(dt);
            updateWindSound(dt);
            return;
        }

        world.time += dt;
        world.difficultyTimer += dt;
        world.elapsed = (performance.now() - flightStartTime) / 1000;

        if (world.difficultyTimer > 15) {
            world.difficultyTimer = 0;
            world.starSpawnInterval = Math.max(1.1, world.starSpawnInterval - 0.2);
        }

        const thrustUp   = keys["w"] || keys["ArrowUp"];
        const thrustDown = keys["s"] || keys["ArrowDown"];
        const turnLeft   = keys["a"] || keys["ArrowLeft"];
        const turnRight  = keys["d"] || keys["ArrowRight"];

        if (thrustUp) {
            hasStartedMoving = true;
            plane.speed += plane.accel * dt;
        }
        if (thrustDown) {
            plane.speed -= plane.accel * dt * 0.9;
        }
        if (!thrustUp && !thrustDown) {
            plane.speed -= plane.friction * dt;
        }
        plane.speed = Math.max(0, Math.min(plane.speed, plane.maxSpeed));
        maxSpeedReached = Math.max(maxSpeedReached, plane.speed);

        if (plane.speed > 5) {
            if (turnLeft) plane.heading -= plane.turnSpeed * dt;
            if (turnRight) plane.heading += plane.turnSpeed * dt;
        }

        const rad = plane.heading;
        const dirX = Math.cos(rad);
        const dirY = Math.sin(rad);

        plane.vx = dirX * plane.speed;
        plane.vy = dirY * plane.speed;

        plane.x += plane.vx * dt;
        plane.y += plane.vy * dt;
        world.movedDistance += plane.speed * dt;

        const gravity = -25;
        let lift = 0;
        if (plane.speed > 80) {
            const liftFactor = (plane.speed - 80) * 0.6;
            if (thrustUp && !thrustDown)      lift = liftFactor;
            else if (thrustDown && !thrustUp) lift = -liftFactor * 0.7;
            else                              lift = liftFactor * 0.25;
        }

        plane.verticalSpeed += (gravity + lift) * dt;
        plane.altitude += plane.verticalSpeed * dt;

        plane.verticalSpeed *= 0.99;

        stallActive = false;
        if (plane.speed < 70 && thrustUp && plane.altitude > 50 && !gameOver) {
            stallActive = true;
            plane.verticalSpeed -= 50 * dt;
            shakeCamera(1.5);
            playStallSound();
        }

        if (plane.altitude > 4500) {
            plane.altitude = 4500;
            if (plane.verticalSpeed > 0) plane.verticalSpeed = 0;
        }

        if (plane.altitude <= 0 && !gameOver) {
            plane.altitude = 0;
            plane.verticalSpeed = 0;
            shakeCamera(3);
            triggerGameOver("Yere Çakıldın", "Çok alçaldın veya hızın yetmedi, uçak düştü. R ile yeniden başlat.");
        }

        const parallaxStrength = 0.2;
        world.clouds.forEach(cloud => {
            const cloudSpeed = cloud.speed + plane.speed * parallaxStrength;
            cloud.x -= cloudSpeed * dt;
        });
        world.clouds = world.clouds.filter(c => c.x + c.w > -50);

        world.stars.forEach(star => {
            star.x -= (star.speed + plane.speed * 0.3) * dt;
        });
        world.stars = world.stars.filter(s => s.x + s.r > -40 && !s.collected);

        world.storms.forEach(storm => {
            storm.x -= (50 + plane.speed * 0.2) * dt;
            storm.lived += dt;
        });
        world.storms = world.storms.filter(s => s.x + s.r > -60 && s.lived < 30);

        world.birds.forEach(b => {
            b.x -= (b.speed + plane.speed * 0.2) * dt;
        });
        world.birds = world.birds.filter(b => b.x > -100);

        if (world.time - world.lastSpawnCloud > 1.3) {
            world.lastSpawnCloud = world.time;
            spawnCloud();
        }
        if (world.time - world.lastSpawnStar > world.starSpawnInterval) {
            world.lastSpawnStar = world.time;
            spawnStar();
        }
        if (world.time - world.lastSpawnStorm > 18) {
            world.lastSpawnStorm = world.time;
            spawnStorm();
        }
        if (world.time - world.lastSpawnBirds > 12) {
            world.lastSpawnBirds = world.time;
            spawnBirdFlock();
        }

        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        world.stars.forEach(star => {
            if (star.collected) return;
            const dx = star.x - cx;
            const dy = star.y - cy;
            const dist = Math.hypot(dx, dy);
            if (dist < world.starCollectRadius) {
                star.collected = true;
                collectedStars++;
                world.score += 50;
                world.fuel = Math.min(100, world.fuel + 10);
                playStarSound();
            }
        });

        world.storms.forEach(storm => {
            const dx = cx - storm.x;
            const dy = cy - storm.y;
            const dist = Math.hypot(dx, dy);
            if (dist < storm.r && !gameOver) {
                let factor = 1;
                if (difficulty === "hard")   factor = 1.6;
                if (difficulty === "easy")   factor = 0.8;
                world.fuel -= dt * storm.drain * factor;
                shakeCamera(2);
                if (Math.random() < 0.01) playThunderSound();
            }
        });

        world.birds.forEach(b => {
            if (b.escaped) return;
            const dx = cx - b.x;
            const dy = cy - b.y;
            if (Math.abs(dx) < 40 && Math.abs(dy) < 40) {
                b.escaped = true;
                world.fuel = Math.max(0, world.fuel - 5);
                shakeCamera(1.2);
            }
        });

        let baseDrain = 2;
        if (difficulty === "easy")  baseDrain *= 0.6;
        if (difficulty === "hard")  baseDrain *= 1.6;
        const speedFactor = plane.speed * 0.015;
        const difficultyFactor = 1 + (world.time / 120) * 0.2;
        const fuelDrain = (baseDrain + speedFactor) * difficultyFactor;
        world.fuel -= fuelDrain * dt;
        if (world.fuel <= 0 && !gameOver) {
            world.fuel = 0;
            shakeCamera(2);
            triggerGameOver("Yakıt Bitti", "Yakıtın tükendi, uçak süzülerek indi. R ile yeniden başlat.");
        }

        world.score += plane.speed * dt * 0.25;

        if (world.elapsed >= world.finishTime && !gameOver) {
            triggerGameOver("Görev Tamamlandı", "Belirlenen süre boyunca havada kaldın! Harika iş çıkardın.");
        }

        speedText.textContent = plane.speed.toFixed(0);
        altText.textContent   = plane.altitude.toFixed(0);
        scoreText.textContent = world.score.toFixed(0);
        timeText.textContent  = world.elapsed.toFixed(1);

        const fuelPercent = Math.max(0, Math.min(100, world.fuel));
        fuelBar.style.width = fuelPercent.toFixed(1) + "%";

        statusBadge.className = "badge";
        if (!hasStartedMoving && !gameOver) {
            statusBadge.textContent = "IDLE";
        } else if (gameOver) {
            statusBadge.textContent = "OFFLINE";
        } else if (stallActive) {
            statusBadge.textContent = "STALL";
            statusBadge.classList.add("badge-stall");
        } else if (plane.speed < 40) {
            statusBadge.textContent = "TAXI";
        } else if (plane.speed < 140) {
            statusBadge.textContent = "CLIMB";
        } else if (plane.speed < 260) {
            statusBadge.textContent = "CRUISE";
        } else {
            statusBadge.textContent = "OVERSPEED";
            statusBadge.classList.add("badge-overspeed");
        }

        updateEngineSound(dt);
        updateWindSound(dt);
    }

    function drawPlane(cx, cy, angle) {
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);

        const scale = 1.3;
        ctx.scale(scale, scale);

        let bodyColor = "#f5f6fa";
        let accentColor = "#3498db";
        if (skins[currentSkin] === "blue") {
            bodyColor = "#dfefff";
            accentColor = "#3498db";
        } else if (skins[currentSkin] === "red") {
            bodyColor = "#ffecec";
            accentColor = "#e74c3c";
        }

        ctx.beginPath();
        ctx.moveTo(0, -22);
        ctx.lineTo(-5, 18);
        ctx.lineTo(5, 18);
        ctx.closePath();
        ctx.fillStyle = bodyColor;
        ctx.fill();
        ctx.strokeStyle = "#2c3e50";
        ctx.lineWidth = 1.5;
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, -16);
        ctx.lineTo(-14, 0);
        ctx.lineTo(-10, 3);
        ctx.lineTo(0, -7);
        ctx.closePath();
        ctx.fillStyle = "#95a5a6";
        ctx.fill();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, -16);
        ctx.lineTo(14, 0);
        ctx.lineTo(10, 3);
        ctx.lineTo(0, -7);
        ctx.closePath();
        ctx.fillStyle = "#95a5a6";
        ctx.fill();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, 6);
        ctx.lineTo(-7, 20);
        ctx.lineTo(7, 20);
        ctx.closePath();
        ctx.fillStyle = "#7f8c8d";
        ctx.fill();
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(0, -14, 6, Math.PI, 0);
        ctx.fillStyle = accentColor;
        ctx.fill();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, 18);
        ctx.lineTo(0, 26);
        ctx.strokeStyle = "#2c3e50";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.restore();
    }

    function drawCloud(cloud) {
        ctx.save();
        ctx.globalAlpha = cloud.alpha;
        ctx.fillStyle = "#ffffff";
        ctx.beginPath();
        const x = cloud.x;
        const y = cloud.y;
        const w = cloud.w;
        const h = cloud.h;
        ctx.ellipse(x, y, w * 0.4, h * 0.6, 0, 0, Math.PI * 2);
        ctx.ellipse(x - w * 0.25, y + 8, w * 0.3, h * 0.5, 0, 0, Math.PI * 2);
        ctx.ellipse(x + w * 0.25, y + 5, w * 0.35, h * 0.55, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    }

    function drawStorm(storm) {
        ctx.save();
        const x = storm.x;
        const y = storm.y;
        const r = storm.r;
        ctx.globalAlpha = 0.7;
        const grd = ctx.createRadialGradient(x, y, r * 0.2, x, y, r);
        grd.addColorStop(0, "#34495e");
        grd.addColorStop(1, "#1c2833");
        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();

        if (Math.random() < 0.02) {
            ctx.globalAlpha = 0.9;
            ctx.strokeStyle = "#f4d03f";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y - r * 0.4);
            ctx.lineTo(x + 10, y);
            ctx.lineTo(x - 5, y + r * 0.4);
            ctx.stroke();
        }

        ctx.restore();
    }

    function drawStarCollectible(star) {
        ctx.save();
        const x = star.x;
        const y = star.y;
        const r = star.r;
        ctx.translate(x, y);
        ctx.rotate(world.time * 1.5);

        const gradient = ctx.createRadialGradient(0, 0, r * 0.1, 0, 0, r);
        gradient.addColorStop(0, "rgba(255, 255, 255, 1)");
        gradient.addColorStop(0.3, "rgba(241, 196, 15, 0.9)");
        gradient.addColorStop(1, "rgba(243, 156, 18, 0)");

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#f1c40f";
        ctx.beginPath();
        const spikes = 5;
        const outerRadius = r * 0.6;
        const innerRadius = r * 0.3;
        for (let i = 0; i < spikes * 2; i++) {
            const radius = i % 2 === 0 ? outerRadius : innerRadius;
            const angle = (i * Math.PI) / spikes;
            ctx.lineTo(Math.cos(angle) * radius, Math.sin(angle) * radius);
        }
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }

    function drawBirdFlock(b) {
        ctx.save();
        ctx.fillStyle = "#2c3e50";
        for (let i = 0; i < b.count; i++) {
            const offsetX = i * -12 + Math.sin(world.time * 2 + i) * 4;
            const offsetY = Math.sin(world.time * 3 + i) * 6;
            const x = b.x + offsetX;
            const y = b.y + offsetY;
            ctx.beginPath();
            ctx.moveTo(x - 4, y);
            ctx.lineTo(x, y - 4);
            ctx.lineTo(x + 4, y);
            ctx.lineTo(x, y + 2);
            ctx.closePath();
            ctx.fill();
        }
        ctx.restore();
    }

    function mixColor(c1, c2, t) {
        function hexToRgb(hex) {
            const clean = hex.replace("#", "");
            const num = parseInt(clean, 16);
            return {
                r: (num >> 16) & 255,
                g: (num >> 8) & 255,
                b: num & 255
            };
        }
        function rgbToHex(r, g, b) {
            return (
                "#" +
                [r, g, b].map(v => {
                    const h = v.toString(16);
                    return h.length === 1 ? "0" + h : h;
                }).join("")
            );
        }

        const a = hexToRgb(c1);
        const b = hexToRgb(c2);
        const r = Math.round(a.r + (b.r - a.r) * t);
        const g = Math.round(a.g + (b.g - a.g) * t);
        const bl = Math.round(a.b + (b.b - a.b) * t);
        return rgbToHex(r, g, bl);
    }

    function drawBackground() {
        const t = world.time * 0.03;
        const dayFactor = (Math.sin(t) + 1) / 2;

        const topColor    = mixColor("#050814", "#eaf6ff", dayFactor);
        const midColor    = mixColor("#141e30", "#87cefa", dayFactor);
        const mid2Color   = mixColor("#243b55", "#4aa3df", dayFactor);
        const bottomColor = mixColor("#020409", "#1b4f72", dayFactor);

        const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
        grd.addColorStop(0, topColor);
        grd.addColorStop(0.4, midColor);
        grd.addColorStop(0.7, mid2Color);
        grd.addColorStop(1, bottomColor);
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (dayFactor < 0.4) {
            ctx.save();
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            for (let i = 0; i < 80; i++) {
                const x = (i * 83) % canvas.width;
                const y = (i * 47) % (canvas.height * 0.5);
                const bright = (0.4 - dayFactor) * 0.9;
                if (Math.random() < 0.004) {
                    ctx.globalAlpha = bright * 1.5;
                } else {
                    ctx.globalAlpha = bright;
                }
                ctx.fillRect(x, y, 2, 2);
            }
            ctx.restore();
        }

        const horizonY = canvas.height * 0.65;

        ctx.save();
        ctx.fillStyle = "#1b2631";
        ctx.fillRect(0, horizonY, canvas.width, canvas.height - horizonY);

        const buildingCount = 18;
        const buildingWidth = canvas.width / buildingCount;
        for (let i = 0; i < buildingCount; i++) {
            const bx = i * buildingWidth;
            const bh = randRange(60, 180);
            const by = horizonY - bh;
            ctx.fillStyle = "#273746";
            ctx.fillRect(bx, by, buildingWidth - 4, bh);

            if (dayFactor < 0.45) {
                ctx.fillStyle = "rgba(241,196,15,0.9)";
                const rows = Math.floor(bh / 20);
                const cols = 3;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        if (Math.random() < 0.4) {
                            const wx = bx + 6 + c * ((buildingWidth - 16) / cols);
                            const wy = by + 5 + r * 16;
                            ctx.fillRect(wx, wy, 4, 6);
                        }
                    }
                }
            }
        }
        ctx.restore();

        ctx.save();
        ctx.strokeStyle = "rgba(255, 255, 255, 0.15)";
        ctx.lineWidth = 1;
        const spacing = 60;
        const diagOffset = (world.time * 40) % spacing;
        ctx.beginPath();
        for (let x = -spacing; x < canvas.width + spacing; x += spacing) {
            ctx.moveTo(x + diagOffset, horizonY);
            ctx.lineTo(x + diagOffset - canvas.height * 0.6, canvas.height);
        }
        ctx.stroke();
        ctx.restore();
    }

    function drawRunway() {
        const runwayWidth = 220;
        const runwayY = canvas.height * 0.75;

        ctx.save();
        ctx.fillStyle = "#2f2f2f";
        ctx.fillRect(canvas.width / 2 - runwayWidth / 2, runwayY, runwayWidth, canvas.height - runwayY);

        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 3;
        ctx.setLineDash([25, 15]);
        ctx.beginPath();
        ctx.moveTo(canvas.width / 2, runwayY + 40);
        ctx.lineTo(canvas.width / 2, canvas.height);
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.fillStyle = "#ffffff";
        ctx.fillRect(canvas.width / 2 - 40, runwayY + 10, 80, 8);
        ctx.fillRect(canvas.width / 2 - 30, runwayY + 24, 60, 6);

        ctx.font = "bold 40px Arial";
        ctx.textAlign = "center";
        ctx.fillText("36", canvas.width / 2, runwayY + 70);

        ctx.restore();
    }

    function draw(dt) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(shakeX, shakeY);

        drawBackground();
        drawRunway();

        world.clouds.forEach(drawCloud);
        world.storms.forEach(drawStorm);
        world.stars.forEach(star => { if (!star.collected) drawStarCollectible(star); });
        world.birds.forEach(drawBirdFlock);

        const cx = canvas.width / 2;
        const cy = canvas.height * 0.5;
        drawPlane(cx, cy, plane.heading);

        ctx.restore();

        if (gameOver) {
            ctx.fillStyle = "rgba(0, 0, 0, 0.35)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        if (stallActive && !gameOver) {
            ctx.save();
            ctx.fillStyle = "rgba(231, 76, 60, 0.15)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        }

        if (!gameOver && plane.speed > 280) {
            ctx.save();
            ctx.fillStyle = "rgba(241, 196, 15, 0.12)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        }
    }

    function loop(timestamp) {
        const dt = (timestamp - lastTime) / 1000;
        lastTime = timestamp;

        update(dt);
        draw(dt);

        requestAnimationFrame(loop);
    }

    requestAnimationFrame(loop);

    window.addEventListener("keydown", e => {
        keys[e.key] = true;

        if (!audioUnlocked) {
            audioUnlocked = true;
            try {
                engineSound.play().then(() => {
                    engineSound.pause();
                    engineSound.currentTime = 0;
                }).catch(() => {});
            } catch (err) {}
        }

        if (e.key === "p" || e.key === "P") {
            togglePause();
        }
        if (e.key === "r" || e.key === "R") {
            resetGame();
            hideMainMenu();
        }
        if (e.key === "c" || e.key === "C") {
            currentSkin = (currentSkin + 1) % skins.length;
            updateSkinDots();
        }
    });

    window.addEventListener("keyup", e => {
        keys[e.key] = false;
    });

    startBtn.addEventListener("click", () => {
        hideMainMenu();
        resetGame();
        running = true;
    });

    muteBtn.addEventListener("click", () => {
        muted = !muted;
        muteBtn.textContent = muted ? "Sesi Aç" : "Sesi Kapat";
        if (muted) {
            [engineSound, windSound, starSound, stallSound, thunderSound, gameOverSound].forEach(a => {
                if (a) { try { a.pause(); } catch(e){} }
            });
        }
    });

    difficultyBtn.addEventListener("click", () => {
        if (difficulty === "easy")      difficulty = "normal";
        else if (difficulty === "normal") difficulty = "hard";
        else                            difficulty = "easy";
        difficultyBtn.textContent = "Zorluk: " + (difficulty === "easy" ? "Kolay" : difficulty === "normal" ? "Normal" : "Zor");
    });

    resumeBtn.addEventListener("click", () => {
        if (!gameOver) {
            running = true;
            hidePauseOverlay();
        }
    });

    restartBtn.addEventListener("click", () => {
        resetGame();
        hidePauseOverlay();
        hideMainMenu();
        running = true;
    });

    skinDots.forEach(dot => {
        dot.addEventListener("click", () => {
            currentSkin = parseInt(dot.dataset.skin, 10);
            updateSkinDots();
        });
    });

    function updateSkinDots() {
        skinDots.forEach((dot, idx) => {
            dot.classList.toggle("active", idx === currentSkin);
        });
    }
    updateSkinDots();

    function togglePause() {
        if (!running || gameOver) return;
        running = false;
        showPauseOverlay("Duraklatıldı", "Devam etmek için P tuşuna bas veya butona tıkla.");
    }

    function triggerGameOver(title, subtitle) {
        if (gameOver) return;
        gameOver = true;
        running = false;
        playGameOverSound();
        showPauseOverlay(title, subtitle, true);
    }

    function showPauseOverlay(title, subtitle, isGameOver = false) {
        pauseTitle.textContent = title;
        pauseSubtitle.textContent = subtitle;
        const elapsed = world.elapsed;
        statTime.textContent   = elapsed.toFixed(1) + " sn";
        statStars.textContent  = collectedStars.toString();
        statMaxSpeed.textContent = maxSpeedReached.toFixed(0) + " kn";
        statScore.textContent  = world.score.toFixed(0);

        pauseOverlay.style.background = isGameOver
            ? "radial-gradient(circle at 50% 20%, rgba(255,255,255,0.08) 0, rgba(120,0,0,0.9) 55%)"
            : "radial-gradient(circle at 50% 20%, rgba(255,255,255,0.08) 0, rgba(0,0,0,0.8) 55%)";

        pauseOverlay.classList.remove("hidden");
    }

    function hidePauseOverlay() {
        pauseOverlay.classList.add("hidden");
    }

    function hideMainMenu() {
        mainMenu.classList.add("hidden");
    }

    function resetGame() {
        world.time = 0;
        world.score = 0;
        world.fuel = 100;
        world.movedDistance = 0;
        world.difficultyTimer = 0;
        world.starSpawnInterval = 2.5;
        world.lastSpawnCloud = 0;
        world.lastSpawnStar = 0;
        world.lastSpawnStorm = 0;
        world.lastSpawnBirds = 0;
        world.elapsed = 0;

        plane.x = 0;
        plane.y = 0;
        plane.heading = 0;
        plane.speed = 0;
        plane.altitude = 80;
        plane.verticalSpeed = 0;

        running = true;
        gameOver = false;
        flightStartTime = performance.now();
        collectedStars = 0;
        maxSpeedReached = 0;
        hasStartedMoving = false;
        stallActive = false;

        initWorld();
        hidePauseOverlay();

        if (centerMsg) {
            centerMsg.style.display = "block";
            centerMsg.classList.remove("fade-out");
            centerMsg.classList.add("fade-in");
        }
    }

    initWorld();
})();
</script>
</body>
</html>
